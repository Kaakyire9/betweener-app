<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Opening Betweener…</title>

    <style>
      :root {
        /* Betweener vibe (feel free to tweak) */
        --bg-top: #f6f1ff;    /* light purple mist */
        --bg-bottom: #fbf6ea; /* oat-milk warm */
        --text: #121212;
        --muted: rgba(18, 18, 18, 0.62);
        --card: rgba(255, 255, 255, 0.65);
        --stroke: rgba(18, 18, 18, 0.08);
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        color: var(--text);
      }

      .wrap {
        width: 100%;
        max-width: 420px;
        padding: 22px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        border-radius: 22px;
        padding: 26px 22px;
        text-align: center;

        /* subtle glass feel */
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .title {
        font-size: 20px;
        font-weight: 650;
        letter-spacing: -0.2px;
        margin: 6px 0 8px;
      }

      .subtitle {
        font-size: 14px;
        line-height: 1.4;
        color: var(--muted);
        margin: 0;
      }

      .row {
        margin-top: 18px;
        display: flex;
        justify-content: center;
      }

      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid rgba(18, 18, 18, 0.10);
        border-top-color: rgba(18, 18, 18, 0.55);
        animation: spin 0.85s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .actions {
        margin-top: 18px;
        display: none;
        gap: 10px;
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: 100%;
        max-width: 280px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.75);
        color: var(--text);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 120ms ease, background 120ms ease;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 10px;
      }

      .fineprint {
        margin-top: 16px;
        font-size: 12px;
        color: rgba(18, 18, 18, 0.45);
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <div class="row">
          <div class="spinner" aria-label="Loading"></div>
        </div>

        <div class="title" id="title">Opening Betweener…</div>
        <p class="subtitle" id="subtitle">
          Please wait while we securely sign you in.
        </p>

        <div class="actions" id="actions">
          <a class="btn" id="openBtn" href="#">Open Betweener</a>
          <div class="hint" id="hintText"></div>
        </div>

        <div class="fineprint" id="fineprint">
          If you didn’t request this sign-in, you can safely close this page.
        </div>
      </div>
    </div>

    <script>
      (function () {
        const titleEl = document.getElementById("title");
        const subtitleEl = document.getElementById("subtitle");
        const actionsEl = document.getElementById("actions");
        const hintEl = document.getElementById("hintText");
        const openBtn = document.getElementById("openBtn");

        // Capture both query (?token_hash=...) and hash (#access_token=...)
        const query = window.location.search || "";
        const hash = window.location.hash || "";

        const queryParams = new URLSearchParams(query);
        const hashParams = new URLSearchParams(hash.replace(/^#/, ""));
        const tokenHash = queryParams.get("token_hash");
        const tokenType = queryParams.get("type");
        const hasAccessToken = hashParams.has("access_token");

        // If we have a token_hash but no session yet, complete verification via Supabase
        if (tokenHash && tokenType && !hasAccessToken) {
          const verifyUrl =
            "https://auth.getbetweener.com/auth/v1/verify" +
            "?token_hash=" + encodeURIComponent(tokenHash) +
            "&type=" + encodeURIComponent(tokenType) +
            "&redirect_to=" + encodeURIComponent("https://getbetweener.com/auth/callback");
          window.location.replace(verifyUrl);
          return;
        }

        // Deep link target (use hash if we have session tokens)
        const deepLink = "betweenerapp://auth/callback" + (hasAccessToken ? hash : query);

        // Basic platform detection (for better instructions)
        const ua = navigator.userAgent || "";
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        const isAndroid = /Android/i.test(ua);

        openBtn.href = deepLink;

        // Try to open the app immediately
        window.location.replace(deepLink);

        // If the app doesn't open, show a premium fallback
        setTimeout(() => {
          titleEl.textContent = "Almost there…";
          subtitleEl.textContent =
            "If Betweener didn’t open automatically, use the button below.";
          actionsEl.style.display = "flex";

          if (isIOS) {
            hintEl.textContent =
              "Tip: This works best from Apple Mail or Safari. If you’re in Gmail, try opening the link in Safari.";
          } else if (isAndroid) {
            hintEl.textContent =
              "Tip: If nothing happens, make sure Betweener is installed and try again.";
          } else {
            hintEl.textContent =
              "You’re on desktop. Open this link on your phone to continue signing in.";
          }
        }, 2500);
      })();
    </script>
  </body>
</html>
